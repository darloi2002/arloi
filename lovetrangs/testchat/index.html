<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <!-- CSS only -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
    <title>Document</title>
</head>
<body>
    <div class="login">
        <button class="loi">
            <img src="images/avt2.jpg" alt="">
        </button>
        <button class="trang">
            <img src="images/avt.jpg" alt="">
        </button>
    </div>
    <div class="wrapper">
        <div class="list-friends">
            
        </div>
        <div class="chat-details">
            <div class="header-chat">
                <div class="messenger">
                    <div class="avt">
                        <img id="img-avt" src="images/avt.jpg" alt="#">
                    </div>
                    <span id="name" class="name">Trang</span>
                </div>
                <div class="thaotac">
                    <a><i class="bi bi-camera-video-fill"></i></a>
                    <a></a><i class="bi bi-person-plus-fill"></i></a>
                    <a></a><i class="bi bi-three-dots"></i></a>
                </div>
            </div>
            <div class="main-chat" id="main-chat">

            </div>
            <div class="text-chat">
                <input id="input-chat" type="text" placeholder="Nhập tin nhắn">
                <a><i class="bi bi-paperclip"></i></a>
                <a><i class="bi bi-image-fill"></i></a>
                <button id="send" class="send">Gửi</button>
            </div>
        </div>
    </div>


    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script> -->
    <script>
        var loi = document.querySelector(".loi");
        var trang = document.querySelector(".trang");
        var login = document.querySelector(".login")
        var user = 0;


        
        
    </script>

<script type="module">
    // import {ReCaptchaV3Provider} from "../firebase/app-check"
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBoTaO7JTTCUaqt0x6Mb6Qc7Z7dz1T5C68",
            authDomain: "chatapp-a7906.firebaseapp.com",
            databaseURL: "https://chatapp-a7906-default-rtdb.firebaseio.com",
            projectId: "chatapp-a7906",
            storageBucket: "chatapp-a7906.appspot.com",
            messagingSenderId: "900351302424",
            appId: "1:900351302424:web:9053f5e7a19b3d00aa5c6d"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        import {getDatabase, ref, get, set, child,onValue, update,remove,
                query, limitToLast, limitToFirst, orderByChild, startAt, startAfter,
                endAt, endBefore, equalTo
                } 
        from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js"

        const db = getDatabase();
    

    const start = Date.now();
    
    var send = document.getElementById("send");
    var inputchat = document.getElementById("input-chat");
    
    var avt = document.getElementById("img-avt");
    var nameUser = document.getElementById("name");

  
    
    function CheckInput(str, screen){
        let arr = [];
        arr = str.split('');
        let count = Math.floor(arr.length/screen);
        var thutu = 0;
        if(count > 0){
            for(var i = 0; i <= count; i++){
                var find = arr.indexOf(' ',thutu+1);
                if(find == -1){
                    thutu += screen;
                    arr.splice(thutu,0,' ');
                }else{
                    thutu += screen;
                }
            }
        }
        return arr.join('');
    }

    function InsertData(){
        const start = Date.now();
        
        if(inputchat.value != ""){
            set(ref(db, "TheChatApp/" + (99999999999999 - start).toString()), {
                Sender: user,
                SendTo: user==1?0:1,
                Content: inputchat.value,
                CreateTime: start,
                OrderTime: 99999999999999 - start,
            })
            .then(()=>{
                inputchat.value = "";
            })
            .catch((error)=>{
                alert("unsuccesful, error" + error);
            });

        }
    }



    // <div class="chat-right-fl">
    //     <div class="chat-right">
    //         <span>hello</span>
    //     </div>
    // </div>
    // <div class="chat-left-fl">
    //     <div class="chat-left">
    //         <span>hello</span>
    //     </div>
    // </div>

    var mainchat = document.getElementById("main-chat");

    function AddItemToChatBox(content, sender, sendto,userId){
        let chatItem = document.createElement("div");
        let chatDetails = document.createElement("div");
        let chatSpan = document.createElement("p");

        if(userId == sender){
            chatItem.setAttribute("class", "chat-right-fl");
            chatDetails.setAttribute("class", "chat chat-right");
        }else{
            chatItem.setAttribute("class", "chat-left-fl");
            chatDetails.setAttribute("class", "chat chat-left");
        }
        if(screen.width < 600){
            chatSpan.innerHTML = CheckInput(content, 29);
        }else{
            chatSpan.innerHTML = CheckInput(content, 40);
        }

        chatDetails.appendChild(chatSpan);
        chatItem.appendChild(chatDetails);
        mainchat.appendChild(chatItem);
    }

    function AddAllItemToTable(TheChatBox){
        mainchat.innerHTML = "";
        TheChatBox.forEach(element =>{
            AddItemToChatBox(element.Content, element.Sender, element.SendTo, user);
        })

    }

    function GetAllDataOnce(){
            const que = query(ref(db, "TheChatApp"),orderByChild("OrderTime"));

            get(que)
            .then((snapshot)=>{
                var chats = [];

                snapshot.forEach(childSnapshot => {
                    chats.push(childSnapshot.val());
                });
                AddAllItemToTable(chats);
            })
        }

    function GetAllDataRealTime(){
        const dbRef = query(ref(db, "TheChatApp"),orderByChild("OrderTime"));

        onValue(dbRef,(snapshot)=>{
            var chats = [];

            snapshot.forEach(childSnapshot => {
                chats.push(childSnapshot.val());
            });
            AddAllItemToTable(chats);
        })
    }

    send.addEventListener('click', InsertData);
    
    inputchat.addEventListener("keyup", function(event){
        event.preventDefault();
        if(event.keyCode === 13){
            send.click();
        }
    })

    window.onload = GetAllDataRealTime;

    
    loi.addEventListener('click',()=>{
        user = 1;
        login.style.display = "none";
        console.log(user);
        GetAllDataOnce();
        nameUser.innerHTML = "Trang";
        avt.src = "images/avt.jpg"
    });
    trang.addEventListener('click',()=>{
        user = 0;
        login.style.display = "none";
        console.log(user);
        GetAllDataOnce();
        
        nameUser.innerHTML = "Lợi";
        avt.src = "images/avt2.jpg"
    });


        
  </script>
    
</body>
</html>